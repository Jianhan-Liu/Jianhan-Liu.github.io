<!DOCTYPE html>
<html lang>
  <head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">

<meta name="theme-color" content="#f8f5ec">
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="北京地铁智能搜索系统的Python实现"><meta name="keywords" content="算法,NLP,机器学习,深度学习"><link rel="alternate" href="/atom.xml" title="Freecoder"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0">
<link rel="canonical" href="http://www.freecoder.site/2019/07/14/北京地铁智能搜索系统/">

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css"><link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css"><script type="text/x-mathjax-config">
    MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
  </script>
  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.0">

<script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":true,"latex":true};
</script>

    <title>北京地铁智能搜索系统的Python实现 - Freecoder</title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Freecoder</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">首页
          </li>
      </a><a href="/archives/">
        <li class="mobile-menu-item">归档
          </li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类
          </li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Freecoder</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            首页
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            归档
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/categories/">
            分类
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/about/">
            关于
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><article class="post">
    <header class="post-header">
      <h1 class="post-title">北京地铁智能搜索系统的Python实现
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-07-14
        </span><span class="post-category">
            <a href="/categories/机器学习/">机器学习</a>
            <a href="/categories/NLP/">NLP</a>
            </span>
        </div>
    </header>

    <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-获取地铁站点线路信息整理得到目标格式数据"><span class="toc-text">1.获取地铁站点线路信息整理得到目标格式数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-数据整理与可视化"><span class="toc-text">2.数据整理与可视化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-搜索策略：最少换乘，最少站数，最少距离"><span class="toc-text">3.搜索策略：最少换乘，最少站数，最少距离</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-增加经过站点的搜索实现"><span class="toc-text">4.增加经过站点的搜索实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-加入站间距离权重的图，使用networkx内置api进行最短路径搜寻"><span class="toc-text">5.加入站间距离权重的图，使用networkx内置api进行最短路径搜寻</span></a></li></ol>
    </div>
  </div><div class="post-content"><h2 id="1-获取地铁站点线路信息整理得到目标格式数据"><a href="#1-获取地铁站点线路信息整理得到目标格式数据" class="headerlink" title="1.获取地铁站点线路信息整理得到目标格式数据"></a>1.获取地铁站点线路信息整理得到目标格式数据</h2><blockquote>
<p>根据经纬度计算直线地理距离，此处<code>station_nodes_dict</code>为{station: [lat, lng], …}格式存储所有站点信息的字典。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">geo_distance</span><span class="params">(origin:str, destination:str)</span>:</span></span><br><span class="line">    origin = station_nodes_dict[origin]</span><br><span class="line">    destination = station_nodes_dict[destination]</span><br><span class="line">    lat1, lon1 = origin</span><br><span class="line">    lat2, lon2 = destination</span><br><span class="line">    radius = <span class="number">6371</span>  <span class="comment"># km</span></span><br><span class="line"></span><br><span class="line">    dlat = math.radians(lat2 - lat1)</span><br><span class="line">    dlon = math.radians(lon2 - lon1)</span><br><span class="line">    a = (math.sin(dlat / <span class="number">2</span>) * math.sin(dlat / <span class="number">2</span>) +</span><br><span class="line">         math.cos(math.radians(lat1)) * math.cos(math.radians(lat2)) *</span><br><span class="line">         math.sin(dlon / <span class="number">2</span>) * math.sin(dlon / <span class="number">2</span>))</span><br><span class="line">    c = <span class="number">2</span> * math.atan2(math.sqrt(a), math.sqrt(<span class="number">1</span> - a))</span><br><span class="line">    distance = radius * c</span><br><span class="line">    <span class="keyword">return</span> distance</span><br></pre></td></tr></table></figure>


<a id="more"></a>   

<blockquote>
<ul>
<li>从网页爬取地铁站信息，整理后最终得到{metro_line: {station:(lat, lng), …}, …}双层字典结构的地铁站信息。</li>
<li>关于使用地图API的选择，可选百度，高德和谷歌，百度的精准度差，谷歌需要科学上网实现，精确度未进行确认，应该不错，折中选择高德地图，若干站点的经纬度需要获取后手动调整。</li>
</ul>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> .api <span class="keyword">import</span> gaode_api</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">url = <span class="string">'https://dt.8684.cn/bj'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_metro_map</span><span class="params">(url)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Return &#123;metro_line_1: &#123;station, ....&#125;, ...&#125;</span></span><br><span class="line"><span class="string">    :param url: metro web page url</span></span><br><span class="line"><span class="string">    :return: &#123;str: &#123;str,...&#125;, ....&#125;</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    metro_map = &#123;&#125;</span><br><span class="line">    response = requests.get(url)</span><br><span class="line">    response.encoding = <span class="string">'utf-8'</span></span><br><span class="line">    soup_content = BeautifulSoup(response.text, features=<span class="string">"lxml"</span>)</span><br><span class="line">    <span class="keyword">for</span> link <span class="keyword">in</span> soup_content.find_all(class_=<span class="string">'sLink'</span>):</span><br><span class="line">        temp = link.text.split()</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'未开通'</span> <span class="keyword">in</span> temp[<span class="number">0</span>] <span class="keyword">or</span> <span class="string">'S2'</span> <span class="keyword">in</span> temp[<span class="number">0</span>]:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'外环'</span> <span class="keyword">in</span> temp[<span class="number">0</span>]:</span><br><span class="line">            temp[<span class="number">0</span>] = temp[<span class="number">0</span>].split(<span class="string">'线'</span>)[<span class="number">0</span>] + <span class="string">'线'</span></span><br><span class="line">        metro_map[temp[<span class="number">0</span>]] = temp[<span class="number">1</span>:]</span><br><span class="line">    <span class="keyword">return</span> metro_map</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_geoinfo_gaode</span><span class="params">(address)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Return the latitude and longitude of address.</span></span><br><span class="line"><span class="string">    :param address: str</span></span><br><span class="line"><span class="string">    :return: float(latitude), float(longitude)</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    output_type = json</span><br><span class="line">    uri = <span class="string">f"https://restapi.amap.com/v3/geocode/geo?address=<span class="subst">&#123;address&#125;</span>&amp;output=<span class="subst">&#123;output_type&#125;</span>&amp;key=<span class="subst">&#123;gaode_api&#125;</span>"</span></span><br><span class="line">    r = requests.get(uri).text</span><br><span class="line">    result = json.loads(r)[<span class="string">'geocodes'</span>][<span class="number">0</span>][<span class="string">'location'</span>]</span><br><span class="line">    lng, lat = result.split(<span class="string">','</span>)</span><br><span class="line">    <span class="keyword">return</span> float(lat), float(lng)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_single_line_geoinfo</span><span class="params">(metro_line, stations)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Return dictionary with format of &#123;metro_line_1: (lat, lng),...)&#125;</span></span><br><span class="line"><span class="string">    :param metro_line: str</span></span><br><span class="line"><span class="string">    :param stations: dict </span></span><br><span class="line"><span class="string">    :return: dict</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    metro_geoinfo = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> station <span class="keyword">in</span> stations:</span><br><span class="line">        metro_geoinfo[station] = get_geoinfo_gaode(metro_line + station + <span class="string">'地铁站'</span>)</span><br><span class="line">    <span class="keyword">return</span> metro_geoinfo    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">zip_station</span><span class="params">(metro_line)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Return a list of previous station and next station combined. [(a, b), (b, c), ...]</span></span><br><span class="line"><span class="string">    :param metro_line: str</span></span><br><span class="line"><span class="string">    :return: list</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    station1 = list(metro_line.keys())</span><br><span class="line">    station2 = list(metro_line.keys())</span><br><span class="line">    station2.pop(<span class="number">0</span>)</span><br><span class="line">    result = list(zip(station1, station2))</span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>googlemaps</code>用法。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> googlemaps </span><br><span class="line">g_maps = googlemaps.Client(key=<span class="string">'yourkey'</span>)</span><br><span class="line">g_maps.geocode(<span class="string">'西红门，地铁站，北京，中国'</span>)[<span class="number">0</span>][<span class="string">'geometry'</span>][<span class="string">'location'</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>&#123;<span class="string">'lat'</span>: <span class="number">39.7898</span>, <span class="string">'lng'</span>: <span class="number">116.328689</span>&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-数据整理与可视化"><a href="#2-数据整理与可视化" class="headerlink" title="2.数据整理与可视化"></a>2.数据整理与可视化</h2><blockquote>
<p>将获取的目标格式数据写入文件，方便手动修改不准确的站点位置以及重复使用。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> open(<span class="string">'Beijing_metro_geoinfo_calibrated.json'</span>, <span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    metro_map = json.load(f)</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>画出整体图形，根据图形效果进行局部偏移较大站点经纬度的调整，将这些站点的api返回经纬度同实际经纬度进行比较校准。</li>
<li>用到的几个<code>networkx</code>的几个<code>api</code>：<code>addedge(), add_nodes_from(), add_edges_from(), add_cycle()</code>以及后面用到的<code>add_weighted_edges_from()</code>。</li>
<li><code>METRO = nx.Graph()</code>的几个实例方法：<code>METRO.neighbor()</code>查看某节点的相邻节点；<code>METRO.degree()</code>查看图中所有节点的度。</li>
</ul>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> networkx <span class="keyword">as</span> nx</span><br><span class="line"><span class="keyword">import</span> matplotlib <span class="keyword">as</span> plt</span><br><span class="line">METRO = nx.Graph()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 存放所有站点经纬度的信息</span></span><br><span class="line">station_nodes_dict = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> metro, stations <span class="keyword">in</span> metro_map.items():</span><br><span class="line">    <span class="keyword">for</span> k,v <span class="keyword">in</span> stations.items():</span><br><span class="line">        station_nodes_dict[k] = v</span><br><span class="line">    <span class="keyword">if</span> metro == <span class="string">'北京地铁2号线'</span>:</span><br><span class="line">        METRO.add_cycle(stations.keys())</span><br><span class="line">    <span class="keyword">elif</span> metro == <span class="string">'北京地铁10号线'</span>:</span><br><span class="line">        METRO.add_cycle(stations.keys())</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        METRO.add_edges_from(zip_station(metro_map[metro]))</span><br><span class="line">    METRO.add_nodes_from(stations.keys()) </span><br><span class="line">    </span><br><span class="line">plt.figure(figsize=(<span class="number">20</span>,<span class="number">20</span>))</span><br><span class="line"><span class="comment"># 调整画布大小查看奇异站点</span></span><br><span class="line">METRO.add_edge(<span class="string">'阎村东'</span>, <span class="string">'苏庄'</span>)</span><br><span class="line">nx.draw(METRO, station_nodes_dict, with_labels = <span class="literal">False</span>, node_size=<span class="number">10</span>)</span><br></pre></td></tr></table></figure>

<h2 id="3-搜索策略：最少换乘，最少站数，最少距离"><a href="#3-搜索策略：最少换乘，最少站数，最少距离" class="headerlink" title="3.搜索策略：最少换乘，最少站数，最少距离"></a>3.搜索策略：最少换乘，最少站数，最少距离</h2><blockquote>
<ul>
<li>三种策略实现。</li>
<li><code>transfer_list</code>列表存储所有换乘站点。</li>
</ul>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">transfer_list_temp = [x <span class="keyword">for</span> x <span class="keyword">in</span> METRO.degree() <span class="keyword">if</span> x[<span class="number">1</span>] &gt; <span class="number">2</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> transfer_list_temp:</span><br><span class="line">    <span class="keyword">if</span> x[<span class="number">0</span>] <span class="keyword">in</span> (<span class="string">'苹果园'</span>, <span class="string">'大红门'</span>):</span><br><span class="line">        transfer_list_temp.remove(x)</span><br><span class="line">transfer_list = [x[<span class="number">0</span>] <span class="keyword">for</span> x <span class="keyword">in</span> transfer_list_temp]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">least_transfer_first</span><span class="params">(paths:list)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_transfer_number</span><span class="params">(path:list)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> len(set(path) &amp; set(transfer_list))</span><br><span class="line">    <span class="keyword">return</span> sorted(paths, key=get_transfer_number)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">least_station_first</span><span class="params">(paths)</span>:</span> </span><br><span class="line">    <span class="keyword">return</span> sorted(paths, key=len)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">least_distance_first</span><span class="params">(paths)</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> len(paths) &lt;= <span class="number">1</span>: <span class="keyword">return</span> paths</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_path_distance</span><span class="params">(path)</span>:</span></span><br><span class="line">        distance = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, len(path)):</span><br><span class="line">            distance += geo_distance(path[i<span class="number">-1</span>], path[i])</span><br><span class="line">        <span class="keyword">return</span> distance</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sorted(paths, key=get_path_distance)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>广度搜索实现，默认最短路径策略搜索。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">search</span><span class="params">(start, destination, METRO_GRAPH, sort_candidate=least_distance_first)</span>:</span></span><br><span class="line">    target_list = []</span><br><span class="line">    </span><br><span class="line">    paths = [[start]]</span><br><span class="line">    visited = set()</span><br><span class="line">    <span class="keyword">while</span> paths: </span><br><span class="line">        path = paths.pop(<span class="number">0</span>)</span><br><span class="line">        frontier = path[<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> frontier <span class="keyword">in</span> visited: <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">for</span> city <span class="keyword">in</span> METRO_GRAPH.neighbors(frontier):</span><br><span class="line">            <span class="keyword">if</span> city <span class="keyword">in</span> path: <span class="keyword">continue</span>  </span><br><span class="line">            new_path = path + [city]</span><br><span class="line">            paths.append(new_path)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> city == destination: </span><br><span class="line">                target_list.append(new_path)</span><br><span class="line">                paths.pop()</span><br><span class="line"></span><br><span class="line">        visited.add(frontier)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> target_list:</span><br><span class="line">        target_list = sort_candidate(target_list)[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">return</span> <span class="string">' -&gt; '</span>.join(target_list)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"No way from <span class="subst">&#123;start&#125;</span> to <span class="subst">&#123;destination&#125;</span>."</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>search(<span class="string">'大红门'</span>, <span class="string">'广渠门外'</span>, METRO, least_station_first)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">'大红门 -&gt; 石榴庄 -&gt; 宋家庄 -&gt; 刘家窑 -&gt; 蒲黄榆 -&gt; 天坛东门 -&gt; 磁器口 -&gt; 广渠门内 -&gt; 广渠门外'</span></span><br></pre></td></tr></table></figure>

<h2 id="4-增加经过站点的搜索实现"><a href="#4-增加经过站点的搜索实现" class="headerlink" title="4.增加经过站点的搜索实现"></a>4.增加经过站点的搜索实现</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">search_go_by</span><span class="params">(start, go_by:list, destination, METRO_GRAPH, sort_candidate=least_station_first)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(go_by, list):</span><br><span class="line">        destination_list = go_by + [destination]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        destination_list = [go_by] + [destination]</span><br><span class="line">        </span><br><span class="line">    result_solution = []</span><br><span class="line">    <span class="keyword">while</span> destination_list:</span><br><span class="line">        temp_destination = destination_list.pop(<span class="number">0</span>)</span><br><span class="line">        temp_result = search(start, temp_destination, METRO_GRAPH, sort_candidate)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> temp_result.startswith(<span class="string">'N'</span>):</span><br><span class="line">            result_solution.append(temp_result)</span><br><span class="line">            start = temp_destination</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">if</span> result_solution:</span><br><span class="line">        result = []</span><br><span class="line">        temp1 = [x.split(<span class="string">' -&gt; '</span>) <span class="keyword">for</span> x <span class="keyword">in</span> result_solution]</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> temp1:</span><br><span class="line">            <span class="keyword">for</span> station <span class="keyword">in</span> x:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> station <span class="keyword">in</span> result:</span><br><span class="line">                    result.append(station)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">' -&gt; '</span>.join(result)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"No way from <span class="subst">&#123;start&#125;</span> to <span class="subst">&#123;destination&#125;</span> go by <span class="subst">&#123;go_by&#125;</span>."</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>search_go_by(<span class="string">'苹果园'</span>, <span class="string">'万寿路'</span>, <span class="string">'六里桥'</span>, METRO)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">'苹果园 -&gt; 古城 -&gt; 八角游乐园 -&gt; 八宝山 -&gt; 玉泉路 -&gt; 五棵松 -&gt; 万寿路 -&gt; 公主坟 -&gt; 莲花桥 -&gt; 六里桥'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>search_go_by(<span class="string">'苹果园'</span>, [<span class="string">'八宝山'</span>, <span class="string">'杨庄'</span>], <span class="string">'六里桥'</span>, METRO)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">'苹果园 -&gt; 古城 -&gt; 八角游乐园 -&gt; 八宝山 -&gt; 杨庄 -&gt; 西黄村 -&gt; 廖公庄 -&gt; 田村 -&gt; 海淀五路居 -&gt; 慈寿寺 -&gt; 西钓鱼台 -&gt; 公主坟 -&gt; 莲花桥 -&gt; 六里桥'</span></span><br></pre></td></tr></table></figure>

<h2 id="5-加入站间距离权重的图，使用networkx内置api进行最短路径搜寻"><a href="#5-加入站间距离权重的图，使用networkx内置api进行最短路径搜寻" class="headerlink" title="5.加入站间距离权重的图，使用networkx内置api进行最短路径搜寻"></a>5.加入站间距离权重的图，使用<code>networkx</code>内置<code>api</code>进行最短路径搜寻</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">zip_station_with_distance</span><span class="params">(metro_line)</span>:</span></span><br><span class="line">    connected_station = []</span><br><span class="line">    station1 = list(metro_line.keys())</span><br><span class="line">    station2 = list(metro_line.keys())</span><br><span class="line">    station2.pop(<span class="number">0</span>)</span><br><span class="line">    result = list(zip(station1, station2))</span><br><span class="line">    <span class="keyword">for</span> each <span class="keyword">in</span> result:</span><br><span class="line">        distance = geo_distance(each[<span class="number">0</span>], each[<span class="number">1</span>])</span><br><span class="line">        connected_station.append(distance)</span><br><span class="line">    result = list(zip(result, connected_station))</span><br><span class="line">    <span class="keyword">for</span> i, x <span class="keyword">in</span> enumerate(result):</span><br><span class="line">        result[i] = x[<span class="number">0</span>] + (x[<span class="number">1</span>],)</span><br><span class="line">    <span class="keyword">return</span> list(result)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">METRO_WITH_DISTANCE = nx.Graph()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 存放所有站点经纬度的信息</span></span><br><span class="line">station_nodes_dict = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> metro, stations <span class="keyword">in</span> metro_map.items():</span><br><span class="line">    <span class="keyword">for</span> k,v <span class="keyword">in</span> stations.items():</span><br><span class="line">        station_nodes_dict[k] = v</span><br><span class="line">    <span class="keyword">if</span> metro == <span class="string">'北京地铁2号线'</span>:</span><br><span class="line">        METRO_WITH_DISTANCE.add_cycle(stations.keys())</span><br><span class="line">    <span class="keyword">elif</span> metro == <span class="string">'北京地铁10号线'</span>:</span><br><span class="line">        METRO_WITH_DISTANCE.add_cycle(stations.keys())</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        METRO_WITH_DISTANCE.add_weighted_edges_from(zip_station_with_distance(metro_map[metro]))</span><br><span class="line">    METRO_WITH_DISTANCE.add_nodes_from(stations.keys()) </span><br><span class="line">    </span><br><span class="line">plt.figure(figsize=(<span class="number">20</span>,<span class="number">20</span>))</span><br><span class="line">METRO_WITH_DISTANCE.add_edge(<span class="string">'阎村东'</span>, <span class="string">'苏庄'</span>)</span><br><span class="line">nx.draw(METRO_WITH_DISTANCE, station_nodes_dict, with_labels = <span class="literal">False</span>, node_size=<span class="number">10</span>)</span><br></pre></td></tr></table></figure>

<p><img src="./pics/lableless.png" alt="lableless"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">plt.figure(figsize=(<span class="number">20</span>,<span class="number">20</span>))</span><br><span class="line">nx.draw(METRO_WITH_DISTANCE, station_nodes_dict, with_labels = <span class="literal">True</span>, node_size=<span class="number">10</span>)</span><br></pre></td></tr></table></figure>

<p><img src="./pics/labled.png" alt="lableless"></p>
<blockquote>
<p>搜索效果对比，10000次搜索，手动实现的<code>search()</code>函数与内置的<code>dijkstra_path()</code>算法相同结果比率为0.4617，手动实现的还有改善提升空间</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line">count = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> test <span class="keyword">in</span> range(<span class="number">10000</span>):</span><br><span class="line">    same_result = <span class="string">'different result'</span></span><br><span class="line">    start = random.choice(list(METRO_WITH_DISTANCE.nodes()))</span><br><span class="line">    destination = random.choice(list(METRO_WITH_DISTANCE.nodes()))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> start != destination:</span><br><span class="line">        api_method = <span class="string">' -&gt; '</span>.join(nx.dijkstra_path(METRO_WITH_DISTANCE, start, destination))</span><br><span class="line">        station_number_1 = len(nx.dijkstra_path(METRO_WITH_DISTANCE, start, destination))</span><br><span class="line">        </span><br><span class="line">        search_method = search(start, destination, METRO)</span><br><span class="line">        station_number_2 = len(search_method.split(<span class="string">' -&gt; '</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> api_method == search_method:</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">            same_result = <span class="string">'same result'</span></span><br><span class="line">        stations_count = <span class="string">'same_station_number'</span> <span class="keyword">if</span> station_number_1 == station_number_2 <span class="keyword">else</span> <span class="string">'different_station_number'</span></span><br><span class="line">        print(<span class="string">f"dijkstra_method: <span class="subst">&#123;api_method&#125;</span> with <span class="subst">&#123;stations_count&#125;</span> stations."</span>)</span><br><span class="line">        print(<span class="string">f"search_method:   <span class="subst">&#123;search_method&#125;</span> with <span class="subst">&#123;stations_count&#125;</span> stations."</span>)</span><br><span class="line">        print(<span class="string">f"<span class="subst">&#123;same_result&#125;</span>"</span>)</span><br><span class="line">        print(<span class="string">'-'</span> * <span class="number">50</span>)</span><br><span class="line">same_rate = count / <span class="number">10000</span></span><br><span class="line">print(<span class="string">f"same rate <span class="subst">&#123;same_rate&#125;</span>."</span>)</span><br></pre></td></tr></table></figure>
      </div>
      
      <footer class="post-footer">
        
        <nav class="post-nav"><a class="next" href="/2019/07/09/Python可变数据结构的陷阱/">
        <span class="next-text nav-default">Python可变数据结构的陷阱</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></footer>
    </article></div><div class="comments" id="comments"></div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a href="mailto:liujianhan@gmail.com" class="iconfont icon-email" title="email"></a>
        <a href="https://github.com/jianhan-liu" class="iconfont icon-github" title="github"></a>
        <a href="https://www.douban.com/people/mrserious/" class="iconfont icon-douban" title="douban"></a>
        </div><div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">&copy;2019<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Django</span>
  </span>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_uv">本站访客数<span id="busuanzi_value_site_uv"></span>人</span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.0"></script>
</body>
</html>
